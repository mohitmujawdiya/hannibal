generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum ProjectStatus {
  ACTIVE
  ARCHIVED
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum PlanStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  REJECTED
}

enum PRDStatus {
  DRAFT
  IN_REVIEW
  APPROVED
}

enum FeatureStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
  CANCELLED
}

model Project {
  id          String        @id @default(cuid())
  name        String
  description String?
  status      ProjectStatus @default(ACTIVE)
  userId      String        @map("user_id")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  deletedAt   DateTime?     @map("deleted_at")

  conversations Conversation[]
  plans         Plan[]
  prds          PRD[]
  features      Feature[]
  personas      Persona[]
  competitors   Competitor[]
  roadmaps      Roadmap[]

  @@map("projects")
}

model Conversation {
  id        String   @id @default(cuid())
  title     String?
  projectId String   @map("project_id")
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  messages Message[]

  @@map("conversations")
}

model Message {
  id             String       @id @default(cuid())
  role           MessageRole
  content        String
  metadata       Json?
  conversationId String       @map("conversation_id")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now()) @map("created_at")

  @@map("messages")
}

model Plan {
  id             String     @id @default(cuid())
  title          String
  status         PlanStatus @default(DRAFT)
  content        Json
  version        Int        @default(1)
  projectId      String     @map("project_id")
  project        Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  conversationId String?    @map("conversation_id")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  prds PRD[]

  @@map("plans")
}

model PRD {
  id        String    @id @default(cuid())
  title     String
  content   Json
  status    PRDStatus @default(DRAFT)
  version   Int       @default(1)
  projectId String    @map("project_id")
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  planId    String?   @map("plan_id")
  plan      Plan?     @relation(fields: [planId], references: [id], onDelete: SetNull)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@map("prds")
}

model Feature {
  id          String        @id @default(cuid())
  title       String
  description String?
  status      FeatureStatus @default(TODO)
  priority    Int?
  riceReach   Int?          @map("rice_reach")
  riceImpact  Int?          @map("rice_impact")
  riceConfidence Int?       @map("rice_confidence")
  riceEffort  Int?          @map("rice_effort")
  riceScore   Float?        @map("rice_score")
  effort      String?
  order       Int           @default(0)
  projectId   String        @map("project_id")
  project     Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parentId    String?       @map("parent_id")
  parent      Feature?      @relation("FeatureTree", fields: [parentId], references: [id], onDelete: SetNull)
  children    Feature[]     @relation("FeatureTree")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  deletedAt   DateTime?     @map("deleted_at")

  roadmapItems RoadmapItem[]

  @@map("features")
}

model Persona {
  id           String   @id @default(cuid())
  name         String
  avatar       String?
  demographics Json?
  goals        Json?
  frustrations Json?
  behaviors    Json?
  projectId    String   @map("project_id")
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("personas")
}

model Competitor {
  id          String   @id @default(cuid())
  name        String
  url         String?
  positioning String?
  strengths   Json?
  weaknesses  Json?
  pricing     String?
  featureGaps Json?    @map("feature_gaps")
  projectId   String   @map("project_id")
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("competitors")
}

model Roadmap {
  id        String   @id @default(cuid())
  title     String
  projectId String   @map("project_id")
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  items RoadmapItem[]

  @@map("roadmaps")
}

model RoadmapItem {
  id        String    @id @default(cuid())
  title     String?
  lane      String
  startDate DateTime? @map("start_date")
  endDate   DateTime? @map("end_date")
  order     Int       @default(0)
  roadmapId String    @map("roadmap_id")
  roadmap   Roadmap   @relation(fields: [roadmapId], references: [id], onDelete: Cascade)
  featureId String?   @map("feature_id")
  feature   Feature?  @relation(fields: [featureId], references: [id], onDelete: SetNull)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@map("roadmap_items")
}
